// AI Chat Thread Styles
@import '../../ProseMirrorMixings.scss';
@import '../../../../sass/components/tag-pill-dropdown';
@import '../../../../sass/components/animations';
@import '../primitives/dropdown/dropdown.scss';
@import '../primitives/infoBubble/infoBubble.scss';

$aiChatThreadMinHeight: 50px;

// ========== AI CHAT THREAD WRAPPER ==========
.ai-chat-thread-wrapper {
    position: relative;
    margin-top: 2rem;
    min-height: $aiChatThreadMinHeight;

    // ===== THREAD CONTENT =====
    .ai-chat-thread-content {
        position: relative;
    }

    // ===== THREAD BOUNDARY SYSTEM =====
    .ai-thread-boundary-indicator {
        position: absolute;
        right: -71px;
        top: -6px;
        // width: 32px;
        width: 60px;
        height: 32px;
        // border: 1px solid red;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border-radius: 50%;
        z-index: 3;
        // cursor: pointer;

        // Add invisible hover area that extends to cover the collapse toggle
        &::after {
            content: '';
            position: absolute;
            width: 60px; // Extended width to cover both elements
            height: 62px;
            pointer-events: auto; // Extends hover area
            // background: rgba(189, 173, 141, .2);
            z-index: 0; // Behind children so they can receive clicks
            // cursor: move;
        }

        .ai-thread-boundary-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1; // Above ::after
            cursor: pointer;

            svg {
                width: 20px;
                height: 20px;
                fill: $nightBlue;
                transition: pupOutTransition(all, 150ms);
            }
        }

        // Collapse toggle icon - appears on hover
        .ai-thread-collapse-toggle {
            margin-left: .15rem;
            width: 20px;
            height: 20px;
            opacity: 0;
            transition: hoverTransition(opacity, 200ms);
            cursor: pointer;
            position: relative;
            z-index: 2; // Above ::after so it can receive clicks

            .collapse-icon {
                display: block;
            }

            svg {
                width: 20px;
                height: 20px;
                fill: lighten($nightBlue, 30%); // Lighter in expanded state
            }

            // Click feedback animation - collapsing (going from expanded to collapsed)
            &.click-feedback svg {
                @include clickToggleFeedbackAnimation((
                    startColor: lighten($nightBlue, 30%),
                    flashColor: lighten($nightBlue, 15%),
                    endColor: $nightBlue
                ));
            }
        }

        // Show collapse toggle on boundary indicator hover
        &:hover .ai-thread-collapse-toggle {
            opacity: 1;
            pointer-events: auto;
        }
    }

    .ai-thread-boundary-indicator-line {
        position: absolute;
        right: -15px;
        top: 0;
        bottom: 0;
        width: 1px;
        background: $steelBlue;
        opacity: 0;
        transform: scaleY(0);
        min-height: $aiChatThreadMinHeight;
        transform-origin: top;
        transition: pupOutTransition(all, 200ms);
        z-index: 5;
        pointer-events: none;

        @include boundaryPointerTriangle((
            direction: 'left',
            anchor: 'bottom',
            horizontalOffset: 0px,
            verticalOffset: 2px,
            size: 2px,
            color: $steelBlue,
            accentColor: $nightBlue
        ));
    }

    // ===== INFO BUBBLE POSITIONING =====
    // The infoBubble primitive handles all its own styling via infoBubble.scss
    // We only need to position the wrapper container here
    .ai-thread-info-bubble {
        position: absolute;
        right: 50px;
        top: 6px;
        z-index: 999999;
    }

    // ===== AI CHAT THREAD CONTROLS CONTAINER =====
    .ai-chat-thread-controls {
        position: absolute;
        bottom: -0.75rem;
        right: -.17rem;
        display: flex;
        align-items: center;
        gap: 0.2rem;
        z-index: 999;

        // All dropdown wrappers inside controls use natural flex flow
        .dropdown-menu-tag-pill-wrapper {
            position: relative;
        }
    }

    // ===== AI SUBMIT BUTTON =====
    .ai-submit-button {
        position: relative; // ensure absolutely positioned state layers anchor here
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        flex: 0 0 32px; // prevent flex shrink causing horizontal shift
        border-radius: 50%;
        opacity: 0.8;
        transition: hoverTransition(all, 400ms);
        cursor: pointer;
        box-sizing: border-box;


        // Button state containers
        .button-default,
        .button-hover,
        .button-receiving {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            transition: hoverTransition(all, 250ms);
        }

        // Default state (always visible)
        .button-default {
            opacity: 1;
            position: relative;
            z-index: 1;
        }

        // Hover and receiving states (overlays)
        .button-hover,
        .button-receiving {
            position: absolute;
            inset: 0; // shorthand for top/left/right/bottom 0
            opacity: 0;
            pointer-events: none;
        }

        // Z-index layering
        .button-hover { z-index: 2; }
        .button-receiving { z-index: 3; }

        // Icon styles
        .send-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;

            svg {
                width: 20px;
                height: 20px;
                fill: $nightBlue;
                transition: hoverTransition(fill, 150ms);
            }
        }

        .stop-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;

            svg {
                width: 26px;
                height: 26px;
                fill: $nightBlue;
                transition: hoverTransition(fill, 150ms);
            }
        }
    }

    // ===== INTERACTION STATES =====

    // Thread boundary visibility
    &.thread-boundary-visible {
        .ai-thread-boundary-indicator-line {
            opacity: 1;
            transform: scaleY(1);
        }
    }

    // Submit button hover (when not receiving)
    &:not(.receiving) .ai-submit-button:hover {
        opacity: 1;
        // Removed border-color to satisfy requirement: no visible border on hover
        // Keep transition for opacity only to avoid layout shift
        transition: hoverTransition(opacity, 250ms);

        .button-default { opacity: 0; pointer-events: none; }
        .button-hover { opacity: 1; pointer-events: auto; }
        .button-receiving { opacity: 0; pointer-events: none; }
    }

    // Thread focus state
    &:focus-within .ai-submit-button {
        opacity: 1;
        transform: translateY(-2px);
    }

    // ===== RECEIVING STATE =====
    &.receiving {
        .ai-submit-button {
            background-color: white;
            transition: hoverTransition(background, 300ms);

            // Hide normal states
            .button-default,
            .button-hover {
                opacity: 0 !important;
                pointer-events: none !important;
            }

            // Show receiving state
            .button-receiving {
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            // Receiving hover state
            &:hover {
                .button-default,
                .button-hover {
                    opacity: 0 !important;
                    pointer-events: none !important;
                }

                .button-receiving {
                    opacity: 1 !important;
                    pointer-events: auto !important;

                    .stop-icon svg {
                        fill: $redPink;
                    }
                }
            }
        }
    }

    // ===== COLLAPSED STATE =====
    // When collapsed, show 50px preview with fade-out gradient at bottom
    &.collapsed {
        .ai-chat-thread-content {
            max-height: 60px;
            overflow: hidden;
            position: relative;

            // Fade-out gradient overlay - starts earlier, fades drastically at bottom
            &::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 100%;
                background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0) 33%,
                    rgba(255, 255, 255, 0.3) 57%,
                    rgba(255, 255, 255, 0.7) 74%,
                    rgba(255, 255, 255, 0.95) 88%,
                    rgba(255, 255, 255, 1) 96%,
                    rgba(255, 255, 255, 1) 100%
                );
                pointer-events: none;
                z-index: 2;
            }
        }

        .ai-thread-boundary-indicator {
            .ai-thread-boundary-icon {
                svg {
                    fill: lighten($nightBlue, 20%);
                }
            }

            // When collapsed, use darker color for toggle icon
            .ai-thread-collapse-toggle svg {
                fill: $nightBlue; // Darker in collapsed state
            }

            // Click feedback animation - expanding (going from collapsed to expanded)
            .ai-thread-collapse-toggle.click-feedback svg {
                @include clickToggleFeedbackAnimation((
                    startColor: $nightBlue,
                    flashColor: lighten($nightBlue, 15%),
                    endColor: lighten($nightBlue, 30%)
                ));
            }
        }


        .ai-thread-boundary-indicator-line {
            background: lighten($steelBlue, 20%)
        }

        .ai-chat-thread-controls {
            display: none;
        }

        &:hover {
            cursor: move;
            .ai-thread-boundary-indicator {
                // .ai-thread-boundary-icon {
                //     svg {
                //         fill: $nightBlue;
                //     }
                // }
            }
            .ai-thread-boundary-indicator-line {
                background: $steelBlue;
            }
        }
    }
}

// ========== AI RESPONSE MESSAGE WRAPPER ==========
.ai-response-message-wrapper {
    margin: 0;
    padding: 0.8rem 0 0.7rem;
    position: relative;

    // ===== USER AVATAR =====
    .user-avatar {
        display: block;
        width: 21px;
        height: 21px;
        border-radius: 99px;
        position: absolute;
        user-select: none;
        left: -55px;
        bottom: 0.01rem;
        cursor: default;

        svg {
            fill: #94999d;
        }

        // Assistant providers
        &.assistant-anthropic {
            left: -55.5px;

            svg {
                fill: #D97757;
                width: 21.5px;
                height: 21.5px;
            }
        }

        &.assistant-openai {
            overflow: hidden;

            svg {
                fill: $aiGreen;
            }

            &.node-receiving-animation svg {
                animation: heartbeatAnimation 1.5s infinite;
                animation-timing-function: ease-in-out;
            }
        }
    }

    // ===== AI RESPONSE MESSAGE =====
    .ai-response-message {
        position: relative;
        z-index: 2;
        margin: 0;
        display: flex;
        align-items: center;
        padding: 0;

        // Boundary indicator
        .ai-response-message-boundaries-indicator {
            position: absolute;
            left: -21px;
            display: block;
            height: 100%;
            width: $aiResponseMessageIndicatorBoundariesWidth;
            transition: height 400ms cubic-bezier(0.19, 1, 0.22, 1);
            background-color: $aiResponseMessageIndicatorColor;
            border-radius: 100px;

            @include boundaryPointerTriangle((
                direction: 'left',
                anchor: 'bottom',
                horizontalOffset: 0px,
                verticalOffset: 8px,
                size: 2px,
                color: $aiResponseMessageIndicatorColor,
                accentColor: $aiResponseMessageIndicatorAccentPointerColor
            ));

            &.node-render-animation {
                animation: popOutAndGrow 300ms cubic-bezier(0.19, 1, 0.22, 1);
            }
        }

        // Message content
        .ai-response-message-content {
            padding: 0;

            &.node-render-animation {
                animation: popOut 400ms cubic-bezier(0.19, 1, 0.22, 1);
            }

            h1, h2, h3, h4, h5, h6 {
                &:first-child {
                    margin-top: 0;
                }
            }
        }
    }
}