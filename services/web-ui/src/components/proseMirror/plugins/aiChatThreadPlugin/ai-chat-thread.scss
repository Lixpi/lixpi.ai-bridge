// AI Chat Thread Styles
@import '$src/components/proseMirror/ProseMirrorMixings.scss';
@import '$src/sass/components/animations';
@import '$src/components/proseMirror/plugins/primitives/dropdown/dropdown.scss';
@import '$src/components/proseMirror/plugins/primitives/infoBubble/infoBubble.scss';

$aiChatThreadMinHeight: 50px;

// User message bubble colors
$userMessageBubbleColor: linear-gradient(135deg, #636d75 0%, #6c747c 100%);
$userMessageBubbleSolidColor: #6a7279; // Solid fallback for the tail
$userMessageTextColor: #fff;

// ========== AI CHAT THREAD WRAPPER ==========
.ai-chat-thread-wrapper {
    position: relative;
    margin-top: 2rem;
    min-height: $aiChatThreadMinHeight;

    // Reserve space so the sticky composer doesn't cover content
    padding-bottom: 5rem;

    // ===== THREAD CONTENT =====
    .ai-chat-thread-content {
        position: relative;

        // Reserve space so sticky composer doesn't cover last message
        padding-bottom: 3.25rem;
    }

    // ===== USER MESSAGE (SENT) =====
    .ai-user-message-wrapper {
        display: block;
        margin: 0.6rem 0;
    }

    .ai-user-message {
        display: table;
        max-width: 85%;
        margin-left: auto;
        margin-right: 1rem;
        padding: 0.6rem 1rem;
        background: $userMessageBubbleColor;
        color: $userMessageTextColor;
        border-radius: 18px 18px 12px 18px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 1.5;
        word-wrap: break-word;

        @include speechBubbleTail((
            position: 'right',
            bubbleColor: $userMessageBubbleSolidColor
        ));
    }

    .ai-user-message-content {
        > *:first-child { margin-top: 0; }
        > *:last-child { margin-bottom: 0; }
    }

    // ===== USER INPUT (COMPOSER) =====
    .ai-user-input-wrapper {
        position: sticky;
        bottom: 0;
        z-index: 5;
        margin-top: 1rem;
        padding: 0.9rem 1rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
    }

    .ai-user-input-content {
        min-height: 44px;

        // Make the typing area look like an input, but still full rich text
        > *:first-child { margin-top: 0; }
        > *:last-child { margin-bottom: 0; }
    }

    .ai-user-input-controls {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.2rem;
        margin-top: 0.4rem;

        .dropdown-menu-tag-pill-wrapper {
            position: relative;
        }
    }

    // ===== SUBMIT BUTTON =====
    .ai-submit-button {
        position: relative; // ensure absolutely positioned state layers anchor here
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        flex: 0 0 32px; // prevent flex shrink causing horizontal shift
        border-radius: 50%;
        opacity: 0.8;
        transition: hoverTransition(all, 400ms);
        cursor: pointer;
        box-sizing: border-box;


        // Button state containers
        .button-default,
        .button-hover,
        .button-receiving {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            transition: hoverTransition(all, 250ms);
        }

        // Default state (always visible)
        .button-default {
            opacity: 1;
            position: relative;
            z-index: 1;
        }

        // Hover and receiving states (overlays)
        .button-hover,
        .button-receiving {
            position: absolute;
            inset: 0; // shorthand for top/left/right/bottom 0
            opacity: 0;
            pointer-events: none;
        }

        // Z-index layering
        .button-hover { z-index: 2; }
        .button-receiving { z-index: 3; }

        // Icon styles
        .send-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;

            svg {
                width: 20px;
                height: 20px;
                fill: $nightBlue;
                transition: hoverTransition(fill, 150ms);
            }
        }

        .stop-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;

            svg {
                width: 26px;
                height: 26px;
                fill: $nightBlue;
                transition: hoverTransition(fill, 150ms);
            }
        }
    }

    // ===== IMAGE GENERATION TOGGLE =====
    .image-generation-toggle {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        opacity: 0.6;
        transition: hoverTransition(opacity, 200ms);

        &:hover {
            opacity: 1;
        }

        &[data-enabled="true"] {
            opacity: 1;

            .image-toggle-btn {
                background: rgba($steelBlue, 0.15);

                svg {
                    fill: $steelBlue;
                }
            }

            .image-size-selector {
                display: block;
            }
        }

        .image-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            transition: hoverTransition(all, 200ms);

            svg {
                width: 16px;
                height: 16px;
                fill: $nightBlue;
                transition: hoverTransition(fill, 150ms);
            }

            &:hover {
                background: rgba($nightBlue, 0.1);
            }
        }

        .image-size-selector {
            display: none;
            font-size: 11px;
            padding: 2px 6px;
            border: 1px solid rgba($nightBlue, 0.3);
            border-radius: 4px;
            background: rgba(#fff, 0.9);
            color: $nightBlue;
            cursor: pointer;
            outline: none;
            transition: hoverTransition(all, 200ms);

            &:hover,
            &:focus {
                border-color: $steelBlue;
            }

            option {
                background: #fff;
                color: $nightBlue;
            }
        }
    }

    // ===== INTERACTION STATES =====

    // Submit button hover (when not receiving)
    &:not(.receiving) .ai-submit-button:hover {
        opacity: 1;
        // Removed border-color to satisfy requirement: no visible border on hover
        // Keep transition for opacity only to avoid layout shift
        transition: hoverTransition(opacity, 250ms);

        .button-default { opacity: 0; pointer-events: none; }
        .button-hover { opacity: 1; pointer-events: auto; }
        .button-receiving { opacity: 0; pointer-events: none; }
    }

    // Thread focus state
    &:focus-within .ai-submit-button {
        opacity: 1;
        transform: translateY(-2px);
    }

    // ===== RECEIVING STATE =====
    &.receiving {
        .ai-submit-button {
            background-color: white;
            transition: hoverTransition(background, 300ms);

            // Hide normal states
            .button-default,
            .button-hover {
                opacity: 0 !important;
                pointer-events: none !important;
            }

            // Show receiving state
            .button-receiving {
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            // Receiving hover state
            &:hover {
                .button-default,
                .button-hover {
                    opacity: 0 !important;
                    pointer-events: none !important;
                }

                .button-receiving {
                    opacity: 1 !important;
                    pointer-events: auto !important;

                    .stop-icon svg {
                        fill: $redPink;
                    }
                }
            }
        }
    }
}

$aiResponseMessageEmptyNodeMinHeight: 1.5rem;

// ========== AI RESPONSE MESSAGE WRAPPER ==========
.ai-response-message-wrapper {
    margin: 0;
    padding: 0.8rem 0 0.7rem;
    position: relative;

    // ===== USER AVATAR =====
    .user-avatar {
        display: block;
        width: 21px;
        height: 21px;
        border-radius: 99px;
        position: absolute;
        user-select: none;
        left: -36px;
        bottom: 0.01rem;
        cursor: default;

        svg {
            fill: #94999d;
        }

        // Assistant providers
        &.assistant-anthropic {
            left: -36.5px;

            svg {
                // fill: #D97757;;
                width: 21.5px;
                height: 21.5px;
            }
        }

        &.assistant-openai {
            overflow: hidden;

            &.node-receiving-animation svg {
                animation: heartbeatAnimation 1.5s infinite;
                animation-timing-function: ease-in-out;
            }
        }
    }

    // ===== AI RESPONSE MESSAGE =====
    .ai-response-message {
        position: relative;
        z-index: 2;
        margin: 0;
        display: flex;
        align-items: flex-start;
        padding: 0;
        gap: 0.4rem;

        &.is-empty {
            min-height: $aiResponseMessageEmptyNodeMinHeight;
            align-items: flex-start;
            padding-top: 0rem;
            padding-left: 1rem;;
        }

        .ai-response-message-spinner {
            display: none;
            pointer-events: none;
            flex: 0 0 auto;
            margin: 0.25rem 0;
        }

        &.is-empty .ai-response-message-spinner,
        .ai-response-message-spinner.is-active {
            display: inline-flex;
            @include horizontalSpinnerAnimation((
                size: .5rem,
                color: $aiResponseMessageIndicatorColor,
                duration: 1000ms,
                delayStep: 150ms,
                gap: 1rem,
                shadowOffset: -0.85rem,
                fontSize: 20px
            ));
        }

        // Message content
        .ai-response-message-content {
            padding: 0.5rem 1rem;
            min-height: $aiResponseMessageEmptyNodeMinHeight;
            background: #fff;
            color: #2a2d2f;
            border-radius: 18px 18px 18px 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            max-width: 85%;
            word-wrap: break-word;
            position: relative;

            @include speechBubbleTail((
                position: 'left',
                bubbleColor: #fff
            ));

            &.node-render-animation {
                animation: popOut 400ms cubic-bezier(0.19, 1, 0.22, 1);
            }

            h1, h2, h3, h4, h5, h6 {
                &:first-child {
                    margin-top: 0;
                }
            }
        }
    }
}

// ========== AI GENERATED IMAGE ==========
.ai-generated-image-wrapper {
    margin: 1rem 0;

    .ai-generated-image-container {
        position: relative;
        // background: rgba($nightBlue, 0.03);
        border-radius: 12px;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;

        &.is-partial {
            .ai-generated-image-content {
                filter: blur(8px);
                opacity: 0.7;
            }
        }
    }

    .ai-generated-image-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        z-index: 2;

        &.is-active {
            display: flex;
        }

        .spinner-ring {
            width: 48px;
            height: 48px;
            border: 3px solid rgba($nightBlue, 0.1);
            border-top-color: $nightBlue;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-text {
            font-size: 0.875rem;
            color: rgba($nightBlue, 0.6);
        }
    }

    .ai-generated-image-content {
        max-width: 100%;
        max-height: 512px;
        object-fit: contain;
        display: none;
        transition: filter 0.3s ease, opacity 0.3s ease;

        &.is-visible {
            display: block;
        }
    }

    .ai-generated-image-actions {
        display: none;
        gap: 0.5rem;
        padding: 0.75rem;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.5));
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        justify-content: center;

        &.is-visible {
            display: flex;
        }

        button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;

            svg {
                flex-shrink: 0;
            }
        }

        .add-to-canvas-btn {
            background: white;
            color: $nightBlue;

            &:hover {
                background: darken(white, 5%);
                transform: translateY(-1px);
            }
        }

        .edit-in-thread-btn {
            background: rgba(white, 0.2);
            color: white;
            backdrop-filter: blur(4px);

            &:hover {
                background: rgba(white, 0.3);
                transform: translateY(-1px);
            }
        }
    }

    .ai-generated-image-prompt {
        display: none;
        padding: 0.75rem 1rem;
        font-size: 0.8rem;
        color: rgba($nightBlue, 0.6);
        background: rgba($nightBlue, 0.03);
        border-top: 1px solid rgba($nightBlue, 0.1);
        font-style: italic;
        line-height: 1.4;

        &.is-visible {
            display: block;
        }
    }
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}