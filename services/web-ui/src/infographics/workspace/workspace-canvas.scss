@import '$src/sass/_variables.scss';
@import '$src/components/bubbleMenu/bubbleMenu.scss';

.workspace-canvas {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    padding: 32px 16px 16px 16px;
    overflow: hidden;
}

.workspace-toolbar {
    position: absolute;
    top: 16px;
    right: 16px;
    z-index: 100;
    padding: 0;
    align-items: center;
    gap: 12px;
    // display: none;
}

.create-document-btn {
    background: var(--primary-color, #3b82f6);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

    &:hover {
        background: var(--primary-color-hover, #2563eb);
    }
}

.add-image-btn {
    background: var(--secondary-color, #10b981);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

    &:hover {
        background: var(--secondary-color-hover, #059669);
    }
}

.zoom-indicator {
    background: rgba(255, 255, 255, 0.9);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    color: #555;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.workspace-pane {
    flex: 1;
    width: 100%;
    height: 100%;
    position: relative;
    cursor: default;
}

.workspace-viewport {
    position: absolute;
    top: 0;
    left: 0;
    transform-origin: 0 0;
    will-change: transform;
}

.workspace-document-node {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    overflow: visible;
    position: relative;

    &:hover .document-resize-handle {
        opacity: 1;
        pointer-events: auto;
    }

    &.is-selected .document-resize-handle,
    &.is-resizing .document-resize-handle {
        opacity: 1;
        pointer-events: auto;
    }

    // On AI chat thread nodes, only show each handle on its own hover
    &.workspace-ai-chat-thread-node {
        &:hover .document-resize-handle {
            opacity: 0;
            pointer-events: auto;
        }

        .document-resize-handle:hover {
            opacity: 1;
        }

        &.is-resizing .document-resize-handle {
            opacity: 0;
            pointer-events: auto;

            &.is-dragging {
                opacity: 1;
            }
        }
    }

    &.is-selected,
    &:focus-within {
        outline: none;
    }

    &.is-resizing {
        user-select: none;

        .document-node-editor {
            pointer-events: none;
        }
    }
}

/* Animated gradient background is rendered via Canvas (see shiftingGradientRenderer.ts) */
.workspace-ai-chat-thread-node {
    position: relative;
    padding: 0;
    overflow: hidden;
    box-shadow: var(--ai-chat-thread-node-box-shadow, none);
    border: var(--ai-chat-thread-node-border, none);

    // Empty thread nodes are hidden until the first message arrives.
    // Uses visibility:hidden so the element remains measurable (offsetWidth/Height)
    // while being invisible. The data attribute is set at DOM-creation time so
    // the browser never paints the node visibly — no flash on page load.
    &[data-thread-empty="true"] {
        visibility: hidden;
        pointer-events: none;
    }

    /* Optional pattern overlay (renderer reads these CSS vars) */
    --gradient-pattern-alpha: 0.22;
    --gradient-pattern-tint: rgba(18, 62, 112, 0.85);
    --gradient-pattern-scale: 1;
    /* Set this to enable a pattern overlay, e.g. url('/patterns/your-pattern.png') */
    /* --gradient-pattern-url: url('/patterns/your-pattern.png'); */

    .shifting-gradient-canvas {
        border-radius: inherit;
    }

    // Position resize handles inside the node boundary (overflow: hidden clips anything outside)
    .document-resize-top-left {
        top: 0;
        left: 0;
    }

    .document-resize-top-right {
        top: 0;
        right: 0;
    }
}

.workspace-ai-chat-thread-node .ai-chat-thread-node-editor {
    position: relative;
    z-index: 1;
    background: transparent !important;
}

/* Override the white background from ProseMirror.scss - make fully transparent */
.workspace-ai-chat-thread-node .ai-chat-thread-node-editor .editor,
.workspace-ai-chat-thread-node .ai-chat-thread-node-editor .ProseMirror {
    background: transparent !important;
}

/* Remove bottom padding that was reserved for the in-thread sticky composer.
   In the workspace canvas the input is a floating element below the node. */
.workspace-ai-chat-thread-node .ai-chat-thread-wrapper {
    padding-bottom: 0;
    margin-top: 0;
}

.workspace-ai-chat-thread-node .ai-chat-thread-wrapper .ai-chat-thread-content {
    padding-bottom: 0;
}

/* Hide the in-editor composer — the workspace uses a floating input instead */
.workspace-ai-chat-thread-node .ai-chat-thread-wrapper .ai-user-input-wrapper {
    display: none;
}

/* Override global ProseMirror padding/min-height for the canvas thread */
.workspace-ai-chat-thread-node .ai-chat-thread-node-editor .ProseMirror {
    min-height: 0;
    padding-bottom: 1rem;
}

/* Hide the document title (h1) inside AI chat thread nodes on the canvas (controlled by showHeaderOnAiChatThreadNodes) */
.workspace-ai-chat-thread-node--hide-title .document-title {
    display: none;
}

/* Vertical rail — drag handle + connection proxy running along AI chat thread + floating input */
/* The outer .workspace-thread-rail spans the full functional height (thread + gap + floating input) */
/* The inner __line child spans only the thread node height for visual display */
.workspace-thread-rail {
    position: absolute;
    z-index: 10;
    pointer-events: auto;
    cursor: move;

    &__line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--rail-thread-height, 100%);
        display: flex;
        align-items: center;
        justify-content: center;

        &::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: var(--rail-width, 3px);
            background-image: var(--rail-gradient, linear-gradient(135deg, #F5EFF9 0%, #E6E9F6 100%));
            border-radius: 2px;
        }
    }

    &__boundary-circle {
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 14px;
        height: 14px;
        line-height: 0;
        pointer-events: none;

        svg {
            width: 100%;
            height: 100%;
            display: block;
        }
    }

}


.workspace-image-node {
    background: transparent;
    border-radius: 4px;
    overflow: visible;
    padding: 0;

    &.is-resizing {
        user-select: none;
    }

    &.is-dragging {
        cursor: move;
    }

    // Anchored mode: image overlaps the AI chat thread node
    &.workspace-image-node--anchored {
        pointer-events: auto;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);

        .image-node-img {
            border-radius: 6px;
        }
    }

    .image-node-img {
        display: block;
        width: 100%;
        height: auto;
        max-width: none;
        border-radius: 4px;
        pointer-events: none;
    }
}

.image-drag-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    cursor: move;
    z-index: 15;
    background: transparent;
}

.image-error {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    min-height: 80px;
    color: #d63031;
    background: #fff5f5;
    font-size: 13px;
    border-radius: 4px;
}

.document-node-editor {
    flex: 1;
    overflow: auto;
    min-height: 100px;
    border-radius: 0 0 8px 8px;
    padding: 16px;
    box-sizing: border-box;
    cursor: text;

    .ProseMirror {
        min-height: 100%;
        width: 100%;
        max-width: 100%;
        padding: 0;
        outline: none;
        box-sizing: border-box;
        overflow-x: hidden;

        > * + * {
            margin-top: 0.5em;
        }

        p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        h1, h2, h3 {
            margin: 0;
            font-weight: 600;
        }

        h1 {
            font-size: 1.5em;
        }

        h2 {
            font-size: 1.25em;
        }

        h3 {
            font-size: 1.1em;
        }

        ul, ol {
            padding-left: 1.5em;
            margin: 0;
        }

        code {
            background: #f4f4f4;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;

            code {
                background: none;
                padding: 0;
                color: inherit;
            }
        }

        blockquote {
            border-left: 3px solid #ddd;
            margin: 0;
            padding-left: 1em;
            color: #666;
        }
    }
}

.editor-error,
.editor-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 80px;
    color: #888;
    font-size: 13px;
}

.editor-error {
    color: #d63031;
    background: #fff5f5;
}

.document-resize-handle {
    position: absolute;
    /* size is set dynamically via JS based on zoom */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: transparent;
    border-radius: 0;
    box-shadow: none;

    svg {
        width: 100%;
        height: 100%;
        fill: $nightBlue !important;
        transition: transform 0.15s ease;
        display: block;
    }

    &:hover svg,
    &.is-dragging svg {
        transform: scale(1.2);
    }
}

.document-drag-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 20px;
    cursor: move;
    z-index: 15;
    background: transparent;
}

// AI chat thread editor container - extends document-node-editor
.ai-chat-thread-node-editor {
    flex: 1;
    overflow: hidden;
    min-height: 100px;
    border-radius: 0 0 8px 8px;
    padding: 0;
    box-sizing: border-box;
    cursor: text;
}

.workspace-document-node.is-dragging .document-drag-overlay {
    cursor: move;
}

.document-resize-top-left {
    top: -6px;
    left: -6px;
    cursor: nwse-resize;

    svg {
        transform: rotate(180deg);
    }

    &:hover svg,
    &.is-dragging svg {
        transform: rotate(180deg) scale(1.2);
    }
}

.document-resize-top-right {
    top: -6px;
    right: -6px;
    cursor: nesw-resize;

    svg {
        transform: rotate(-90deg);
    }

    &:hover svg,
    &.is-dragging svg {
        transform: rotate(-90deg) scale(1.2);
    }
}

.document-resize-bottom-left {
    bottom: -6px;
    left: -6px;
    cursor: nesw-resize;

    svg {
        transform: rotate(90deg);
    }

    &:hover svg,
    &.is-dragging svg {
        transform: rotate(90deg) scale(1.2);
    }
}

.document-resize-bottom-right {
    bottom: -6px;
    right: -6px;
    cursor: nwse-resize;

    svg {
        transform: rotate(0deg);
    }

    &:hover svg,
    &.is-dragging svg {
        transform: rotate(0deg) scale(1.2);
    }
}

// Bottom resize handles on the per-thread floating AI input
.ai-prompt-input-thread-persistent {
    // Only show each handle on its own hover
    .document-resize-handle {
        pointer-events: auto;
    }

    .document-resize-handle:hover {
        opacity: 1;
    }

    &.thread-hovered .document-resize-handle {
        pointer-events: auto;
    }
}

// Workspace edges
.workspace-edges-layer {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 5;
    // Container passes events through to nodes below
    pointer-events: none;

    .connector-svg {
        // SVG itself doesn't block events
        pointer-events: none;

        .workspace-edge-node {
            opacity: 0;
            pointer-events: none;
        }

        // Edges group
        .connector-edges {
            pointer-events: none;
        }

        // Visible edge paths should not block clicks
        .connector-edge {
            pointer-events: none;
        }

        // Markers should not block clicks
        marker, defs {
            pointer-events: none;
        }

        // Node rects in edges group
        .connector-nodes {
            pointer-events: none;
        }

        // Default edge color
        .workspace-edge {
            stroke: $steelBlue;
        }

        // Arrowhead markers
        .connector-arrowhead {
            fill: $steelBlue;
            stroke: $steelBlue;
        }

        .workspace-edge.is-selected {
            stroke: $steelBlue;
        }

        .workspace-edge-temp {
            stroke: rgba($steelBlue, 0.6);
        }
    }
}

.workspace-edge-endpoints-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 25;
    pointer-events: none;
}

.workspace-edge-endpoint {
    position: absolute;
    transform: translate(-50%, -50%);
    width: calc(12px / var(--zoom-scale, 1));
    height: calc(12px / var(--zoom-scale, 1));
    border-radius: 999px;
    background: white;
    border: calc(2px / var(--zoom-scale, 1)) solid $nightBlue;
    pointer-events: auto;
    cursor: crosshair;
}

// Connection handles on nodes
.workspace-handle {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: calc(10px / var(--zoom-scale, 1));
    height: calc(10px / var(--zoom-scale, 1));
    border-radius: 999px;
    background: $nightBlue;
    opacity: 0;
    pointer-events: none;
    z-index: 18;
    transition: opacity 0.15s ease-out;

    &:hover {
        transform: translate(-50%, -50%) scale(1.2);
    }
}

.workspace-handle.left {
    left: 0;
}

.workspace-handle.right {
    left: 100%;
}

// Show handles on hover for all node types
.workspace-document-node:hover .workspace-handle,
.workspace-image-node:hover .workspace-handle,
.workspace-ai-chat-thread-node:hover .workspace-handle,
.workspace-document-node.is-selected .workspace-handle,
.workspace-image-node.is-selected .workspace-handle,
.workspace-ai-chat-thread-node.is-selected .workspace-handle {
    opacity: 1;
    pointer-events: auto;
}
